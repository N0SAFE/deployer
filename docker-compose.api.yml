services:
   # Initialize Traefik configuration directory structure
    traefik-init:
        container_name: ${COMPOSE_PROJECT_NAME:-nextjs-nestjs}-traefik-init
        image: alpine:latest
        restart: "no"  # Run once and exit
        volumes:
            - traefik_configs_dev:/etc/traefik
        command: |
            sh -c "
            echo 'Initializing Traefik configuration directory structure...'
            mkdir -p /etc/traefik/dynamic
            mkdir -p /etc/traefik/certs
            mkdir -p /etc/traefik/logs
            mkdir -p /etc/traefik/plugins
            echo 'Creating base traefik.yml configuration...'
            cat > /etc/traefik/traefik.yml << 'EOF'
            # Traefik v3 Configuration
            api:
              dashboard: true
              insecure: true

            providers:
              docker:
                exposedByDefault: false
              file:
                directory: /etc/traefik/dynamic
                watch: true

            entryPoints:
              web:
                address: ':80'
              websecure:
                address: ':443'

            log:
              level: INFO
              filePath: /etc/traefik/logs/traefik.log

            accessLog:
              filePath: /etc/traefik/logs/access.log
            EOF
            echo 'Traefik configuration initialized successfully!'
            "
        networks:
            - api_network_dev

    # Database for development
    api-db-dev:
        container_name: ${COMPOSE_PROJECT_NAME:-nextjs-nestjs}-api-db-dev
        image: postgres:16-alpine
        restart: unless-stopped
        environment:
            POSTGRES_USER: ${DB_USER:-postgres}
            POSTGRES_PASSWORD: ${DB_PASSWORD:-postgres}
            POSTGRES_DB: ${DB_DATABASE:-nestjs_api}
        volumes:
            - api_db_data_dev:/var/lib/postgresql/data
        healthcheck:
            test: ["CMD-SHELL", "pg_isready -U ${DB_USER:-postgres} -d ${DB_DATABASE:-nestjs_api}"]
            interval: 10s
            timeout: 5s
            retries: 5
        networks:
            - api_network_dev

    # Redis cache for development
    api-cache-dev:
        container_name: ${COMPOSE_PROJECT_NAME:-nextjs-nestjs}-api-cache-dev
        image: redis:8-alpine
        restart: unless-stopped
        healthcheck:
            test: ["CMD-SHELL", "[ $$(redis-cli ping) = 'PONG' ]"]
            interval: 10s
            timeout: 5s
            retries: 5
            start_interval: 5s
            start_period: 30s
        networks:
            - api_network_dev

    # NestJS API for development
    api-dev:
        container_name: ${COMPOSE_PROJECT_NAME:-nextjs-nestjs}-api-dev
        build:
            context: .
            dockerfile: ./docker/Dockerfile.api.dev
            tags:
              - "${COMPOSE_PROJECT_NAME:-nextjs-nestjs}-api-dev:latest"
              - "${COMPOSE_PROJECT_NAME:-nextjs-nestjs}-api-dev:${API_VERSION:-dev}"
        depends_on:
            api-db-dev:
                condition: service_healthy
            traefik-dev:
                condition: service_healthy
            api-cache-dev:
                condition: service_healthy
        restart: unless-stopped
        ports:
            - "${API_PORT:-3005}:${API_PORT:-3005}"
            - "${DRIZZLE_STUDIO_PORT:-4983}:4983"
        volumes:
            # Mount Docker socket for container management
            - /var/run/docker.sock:/var/run/docker.sock
            # Mount entire Traefik configuration directory
            - traefik_configs_dev:/app/traefik-configs
            # Mount file upload and extraction storage
            - file_uploads_dev:/app/uploads
            - file_extracted_dev:/app/extracted
            # Mount static file serving storage (for deployed apps)
            - static_files_dev:/app/static
            # Mount source code for hot reloading
            - ./apps/api:/app/apps/api
            # Mount essential configuration files needed for NestJS build
            - ./apps/api/nest-cli.json:/app/apps/api/nest-cli.json
            - ./apps/api/tsconfig.json:/app/apps/api/tsconfig.json
            - ./apps/api/tsconfig.build.json:/app/apps/api/tsconfig.build.json
            # Keep packages in sync
            - ./packages:/app/packages
            # Anonymous volumes for dependencies only (not dist)
            - /app/node_modules
            - /app/apps/api/node_modules
            # No dist volume - let TypeScript create it on the fly
            # Persistent caches (shared with web/doc for faster cold starts)
            - bun_cache_dev:/root/.bun/install/cache
            - turbo_cache_dev:/root/.cache/turbo
        environment:
            NODE_ENV: development
            API_PORT: ${API_PORT:-3005}
            COMPOSE_PROJECT_NAME: ${COMPOSE_PROJECT_NAME:-nextjs-nestjs}
            DATABASE_URL: postgresql://${DB_USER:-postgres}:${DB_PASSWORD:-postgres}@api-db-dev:5432/${DB_DATABASE:-nestjs_api}
            AUTH_SECRET: ${AUTH_SECRET:-fallback-auth-secret}
            JWT_SECRET: ${JWT_SECRET:-fallback-jwt-secret}
            PASSKEY_RPID: ${PASSKEY_RPID:-localhost}
            PASSKEY_RPNAME: ${PASSKEY_RPNAME:-NestJS App}
            PASSKEY_ORIGIN: ${PASSKEY_ORIGIN:-http://localhost:3000}
            REDIS_URL: redis://api-cache-dev:6379
            NEXT_PUBLIC_WEB_URL: ${NEXT_PUBLIC_APP_URL:-http://localhost:3000}
            # CORS Configuration for cross-origin requests from web app
            CORS_ORIGIN: ${NEXT_PUBLIC_APP_URL:-http://localhost:3000}
            # Development specific settings
            LOG_LEVEL: debug
            # Enable polling for file watching to avoid EBUSY errors in Docker on Windows
            CHOKIDAR_USEPOLLING: "true"
            BETTER_AUTH_URL: ${NEXT_PUBLIC_APP_URL:-http://localhost:3000}
            BETTER_AUTH_SECRET: ${BETTER_AUTH_SECRET:-better-auth-fallback-secret}
            # Development authentication
            DEV_AUTH_KEY: ${DEV_AUTH_KEY:-dev-fallback-key}
            MASTER_USER: ${MASTER_USER:-admin@admin.com/adminadmin}
            # Traefik Configuration
            TRAEFIK_DOMAIN: ${TRAEFIK_DOMAIN:-localhost}
            TRAEFIK_ACME_EMAIL: ${TRAEFIK_ACME_EMAIL:-admin@localhost}
            TRAEFIK_CONFIG_BASE_PATH: /app/traefik-configs
            # Turbo Remote Cache Configuration
            TURBO_TOKEN: ${TURBO_TOKEN}
            TURBO_TEAM: ${TURBO_TEAM}
            # Increase Node.js heap for heavy dev tasks (use hyphenated flag)
            # Set to 7000 MB; adjust based on host resources
            NODE_OPTIONS: "--max-old-space-size=7000"
        healthcheck:
            test: wget --no-verbose --tries=1 --spider http://127.0.0.1:${API_PORT:-3005}/health || exit 1
            start_period: 15s
            interval: 15s
            timeout: 15s
            retries: 5
        # Memory limits to avoid host swap storms and make failures deterministic
        mem_limit: 8g
        memswap_limit: 8g
        ulimits:
            nproc: 65535
            nofile: 65535
        networks:
            - api_network_dev

    # Traefik reverse proxy for development
    traefik-dev:
        container_name: ${COMPOSE_PROJECT_NAME:-nextjs-nestjs}-traefik-dev
        image: traefik:v3.2
        restart: unless-stopped
        depends_on:
            traefik-init:
                condition: service_completed_successfully
        ports:
            - "80:80"   # HTTP (using different port to avoid conflicts)
            - "443:443"  # HTTPS (using different port to avoid conflicts) 
            - "8095:8080" # Traefik Dashboard
        volumes:
            # Mount Docker socket for auto-discovery
            - /var/run/docker.sock:/var/run/docker.sock:ro
            # Mount entire Traefik configuration directory
            - traefik_configs_dev:/etc/traefik
            # Mount static files for serving deployed applications
            - static_files_dev:/app/static:ro
        command:
            - --configfile=/etc/traefik/traefik.yml
        healthcheck:
            test: ["CMD-SHELL", "wget --no-verbose --tries=1 --spider http://127.0.0.1:8080/api/rawdata || exit 1"]
            start_period: 30s
            interval: 10s
            timeout: 5s
            retries: 5
        labels:
            - "traefik.enable=false"  # Don't proxy Traefik itself
        networks:
            - api_network_dev

networks:
  api_network_dev:
    name: ${COMPOSE_PROJECT_NAME:-nextjs-nestjs}_api_network_dev
    driver: bridge
    driver_opts:
      com.docker.network.bridge.host_binding_ipv4: "127.0.0.1"

volumes:
    api_db_data_dev:
        name: ${COMPOSE_PROJECT_NAME:-nextjs-nestjs}_api_db_data_dev
    traefik_configs_dev:
        name: ${COMPOSE_PROJECT_NAME:-nextjs-nestjs}_traefik_configs_dev
    file_uploads_dev:
        name: ${COMPOSE_PROJECT_NAME:-nextjs-nestjs}_file_uploads_dev
    file_extracted_dev:
        name: ${COMPOSE_PROJECT_NAME:-nextjs-nestjs}_file_extracted_dev
    static_files_dev:
        name: ${COMPOSE_PROJECT_NAME:-nextjs-nestjs}_static_files_dev
    bun_cache_dev:
        name: ${COMPOSE_PROJECT_NAME:-nextjs-nestjs}_bun_cache_dev
    turbo_cache_dev:
        name: ${COMPOSE_PROJECT_NAME:-nextjs-nestjs}_turbo_cache_dev
